# 高度な分岐予測

## 分岐履歴のパターン
* 実際のプログラムでは, 条件分岐の成立/不成立には一定のパターンが存在することが多い
  * 例えば, 一定回数のループ処理の場合, 決まった回数の成立のあと1度だけ不成立になったり…
* そうしたケースにおいて分岐予測の精度を高めるには, 過去何回かにわたる分岐の成立/不成立の履歴を, そのまま記録しておくのが有効
  * 対象の分岐に対してのみの履歴を記録して使うローカル分岐予測
  * 対象箇所以外も含めて一連の処理の流れの中での履歴を記録して使うグローバル分岐予測
* 実際には, 履歴と分岐命令のアドレスを合わせて圧縮(XORを取るなど)したような値を使うなど, ややこしいことをしたりする
  * 履歴は長く記録するほど基本的には精度が上がるが, 指数的に取りうるパターンが増えて必要なリソースも増大してしまうため, その節約の意味がある
  * 分岐予測の精度は重要だが, 予測を外しても計算の整合性に問題が出るわけではないので, 圧縮による競合とかは気にしすぎないで良い

## indirect branch
* 分岐にはループや `if` によるものだけでなく, ジャンプ先が変数になっていて動的に決定するような `indirect branch` もある
  * 一般的な分岐と異なり, 成立/不成立の2択ではなく分岐先アドレス自体が不明
  * 予測自体は難しいが, 近年のCPUでは予測をそれにも取り組んでいる
* indirect branchで一番多いのはsubroutine callからのreturn
  * return = call stackに積まれたアドレスを元にジャンプする = indirect branch
