# 緩和策

* CPUマイクロコードの更新も必要であり, ややこしい

## 影響箇所について

* 潜在的には, indirect branchをキーにして別の処理を呼び出せてしまうため, 影響箇所は多い
* 限られた権限で実行されるコードから, より上位の権限にしかアクセスできないメモリ上のデータを間接的に取得する性質のものであり, variant 1と同様にOS, Hypervisor, browserが主に影響を受ける
* とはいえ, CPUの内部実装である分岐予測の詳細を調査した上で, 複雑な手順を踏んで実行できるものであり, 難易度は高いと思われる

## 対策方法について

* Intelは `IBPB`, `IBRS`, `STIBP` という, 分岐予測に用いいるバッファを制御する(flushしたり...)機能をマイクロコードの更新として配布
  * 基本的には, これらの機能を適切なタイミングで呼び出すように, ソフトウェアを更新するのが必要
  * マイクロコードの更新はmitigationのための機能拡張であり, それ自体で対応が完了するわけではない
* `retpoline` というテクニックによる回避も考えられている
  * `return` が本質的には indirect branch であることを利用し, indirect branch を `return` で置き換えるようなもの
  * `return` の場合は, 通常のindirect branchと異なりRSB(Return Stack Buffer)から予測を行う
  * RSBが空の際に通常のindirect branchの処理にフォールバックするCPUもあり, 万能ではない
  * 直接 `retpoline` のコードを書くのも大変なので, コンパイラが対応し, `retpoline` を利用したコードを吐けるようになっている
* Linuxカーネルでは, 利用できるものや状況に応じて `retpoline` と `IBPB` 等を利用した方法を使い分けたり併用したりしている

## まとめ
* 基本的にはVariant 1と似ており, 各種ソフトウェアで対応が必要
* 更に, マイクロコードの更新が必要な点に注意
