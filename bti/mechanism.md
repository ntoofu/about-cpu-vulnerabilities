# 仕組み

* 分岐予測の仕組みの中で使われるバッファ等が, 特権モードと一般のモードで共通してしまっていることを利用する
* `indirect branch` に対する **分岐先予測を誘導**し , 投機的に好きなコード片(gadget)を実行させる
  * Project Zeroでは, そのためにHaswellにおける分岐予測の仕組みの詳細をreverse engineeringしている
* 特権モードで実行されるであろうindirect branchを予想し, その呼び出しの分岐先を誘導することで, 権限の問題はクリアしている
  * Guest VMからHypervisorに処理が移行したタイミングで実行されるはずの関数呼び出しなどを狙う
* 投機的に実行させるコードでは, Variant 1と同様に読み取ったデータを元にキャッシュに痕跡を残して, ユーザープログラムからそれを読み取る

## Haswellの分岐予測の仕組みと悪用
* ある分岐命令のアドレスとその分岐先のアドレスの対を, 履歴に基づいて記録した BTB (Branch Target Buffer)を用いてアドレスを予測する
  * 節約のため, アドレス全体ではなくその一部のみを記録して使う
  * そのため, 悪用する観点ではcollisionを起こさせることが可能で分岐先の誘導が出来る
* 58bitのBHB (Branch History Buffer) には, 過去29回分の分岐予測のパターン(分岐命令のアドレスと, 分岐先アドレスの組)が圧縮して記録されている
  * その分岐が, 毎回同じアドレスを指し示すのか, 複数の分岐先を持っているのか, ということを判別するために使われるらしい
    * なぜBHBで判別が出来るかはわかりませんでした...
  * 分岐先のアドレス自体は, BTBを使って予測する

## 分岐予測を利用したアドレスの推定
* 狙った処理をこの脆弱性で呼び出すためには, それらのアドレスが分かっていないといけない
* このアドレスの推定にも, 分岐予測の仕組みを利用する
  * 分岐予測器の状態を操作した上で分岐を発生させ, その分岐予測の成否を観測することでアドレスに関する部分的な情報を得る
