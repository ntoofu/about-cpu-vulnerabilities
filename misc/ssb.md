# Speculative Store Bypass

* CVE-2018-3639
* 条件が揃えばメモリの読み出しが先行する書き込みを待たず投機的に実行されることがあり, それを利用してサイドチャネル攻撃につなげることで本来読めない情報を読む
  * Memory disambiguationの実装の中には, ストアとのconflictの確認を待たず投機的にロードを行うものがある
* 性質としては Variant 1 によく似ており, 特定のパターンの処理でソフトウェア的には読めないつもりだった値が読めてしまう
* 公開されたのは 2018年5月
* Variant 4 とも

## Memory Disambiguation
* Out-of-Order実行において, メモリのロード/ストアの順序が変わることもあるが, 同じアドレス(位置)への読み書きは注意が必要
  * メモリ上の同じアドレスのデータを読んでから書くのと, 書いてから読むのでは結果が変わってきてしまう
  * 読み書きの順序の重要性はレジスタでも同じだが, 命令デコード時に同じレジスタかどうか分かるのに対し, メモリの場合アドレスを計算しないと分からないことがある
  * メモリ上の同じアドレスへの読み書きによる命令の依存関係を解決する = Memory disambiguation
* 単純には, ロードやストアは全て順番通りに(in-orderに)実行してしまえばよいが, 性能面では不利
* Load queue/Store queueに実行したLoad/Storeを記録して投機的に処理を進め, 分かり次第整合性を担保したりする方法も採られる
  * 同じアドレスへの順序が前後した読み書きがあれば検知する
    * 例1) Store時にLoad queueをアドレスで検索して, 後続するLoadが先になされているか見る
    * 例2) Out-of-Order実行の結果得られた値を確定させる(retirement)際に再度loadして値が同一であるチェックをする
  * 異常が検知されれば, 一連の処理を再実行する

## 緩和策
* Variant 1 と性質が似ていることもあり, 影響を受けるのはVariant 1と同じようにSandbox環境を提供するようなソフトウェア
* Memory Disambiguationを制御するためのmicrocode修正を適用した上で, ソフトウェアの更新が必要
